{%- for m in site.data.members -%}
  {%- if m.id == include.id -%}
    {%- assign member = m -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- capture member_full_name -%}{{ member.given }} {{ member.family }}{%- endcapture -%}
{%- if site.lang == "jp" and member["name-jp"] -%}
  {%- capture member_full_name -%}{{ member["name-jp"] }}{%- endcapture -%}
{%- endif -%}

{%- comment -%} Determine member picture or fallback {%- endcomment -%}
{%- capture default_picture -%}{{ site.baseurl_root }}/assets/members/nopicture.png{%- endcapture -%}
{%- capture expected_picture_path -%}/assets/members/{{ member.id }}.jpg{%- endcapture -%}

{%- assign member_picture = default_picture -%}
{%- for file in site.static_files -%}
  {%- if file.path == expected_picture_path -%}
    {%- capture member_picture -%}{{ site.baseurl_root }}{{ file.path }}{%- endcapture -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Subtitle: role + optional website link {%- endcomment -%}
{%- capture subtitle -%}
  {%- case member.role -%}
    {%- when "director" %}{% t roles.director %}
    {%- when "deputy-director" %}{% t roles.deputy-director %}
    {%- when "permanent" %}{% t roles.permanent-researcher %}
    {%- when "adjunct" %}{% t roles.adjunct-member %}
    {%- when "postdoc" %}{% t roles.postdoctoral-fellow %}
    {%- when "engineer" %}{% t roles.research-engineer %}
    {%- when "phd" %}{% t roles.phd-student %}
    {%- when "master" %}{% t roles.master-student %}
    {%- when "undergraduate" %}{% t roles.undergraduate-student %}
    {%- when "non-degree" %}{% t roles.non-degree-student %}
    {%- when "alumni", "alumni-star" %}{% t roles.alumni %}
  {%- endcase -%}
{%- endcapture -%}

{%- if member.website -%}
  {%- capture subtitle -%}<br/>{{subtitle}} &mdash; <a href="{{member.website}}" target="_blank">{% t member-page.personal-website %} <i class="bi bi-globe" style="font-size: small;"></i></a>{%- endcapture -%}
{%- else -%}
  {%- capture subtitle -%}<br/>{{subtitle}}{%- endcapture -%}
{%- endif -%}

{%- capture crumbs -%}<a href="{{ site.baseurl }}/members.html">{% t pages.members %}</a>{%- endcapture -%}
{%- assign crumbs = crumbs | split: "," -%}
{%- include breadcrumbs.html crumbs=crumbs breadcrumbs=member_full_name title=member_full_name subtitle=subtitle -%}

<!-- Page Content -->
<div class="container py-4">
  <div class="row align-items-center">
    <div class="col-md-5 col-12 mb-4 d-flex align-items-center justify-content-center">
      <div id="memberCarousel" class="carousel slide" data-bs-ride="carousel">
        {%- assign carousel_files = "" | split: "" -%}
        {%- assign member_assets_prefix = "/assets/members/" | append: member.id | append: "/" -%}
        {%- assign main_image = member_picture -%}

        {%- assign carousel_files = carousel_files | push: main_image -%}

        {%- for f in site.static_files -%}
          {%- assign f_base = f.path | remove_first: member_assets -%}
          {%- if f_base != f.path -%}
            {%- capture carousel_files -%}{{carousel_files}},{{site.baseurl_root}}{{f.path}}{%- endcapture -%}
          {%- endif -%}
        {%- endfor -%}

        {%- assign carousel_size = carousel_files | size -%}

        {%- if carousel_size > 1 -%}
        <div class="carousel-indicators">
          {%- for f in carousel_files -%}
            <button type="button"
                    data-bs-target="#memberCarousel"
                    data-bs-slide-to="{{ forloop.index0 }}"
                    class="{% if forloop.first %}active{% endif %}"
                    aria-current="{% if forloop.first %}true{% endif %}"
                    aria-label="Slide {{ forloop.index }}">
            </button>
          {%- endfor -%}
        </div>
        {%- endif -%}

        <div class="carousel-inner">
          {%- for f in carousel_files -%}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img src="{{ f }}" class="d-block rounded" alt="{{ member_full_name }} image {{ forloop.index }}">
            </div>
          {%- endfor -%}
        </div>

        {%- if carousel_size > 1 -%}
        <button class="carousel-control-prev" type="button" data-bs-target="#memberCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#memberCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
        {%- endif -%}
      </div>
    </div>

    <div class="col-md-7 col-12">
      {%- if member.bio -%}
        <h3>{% t member-page.bio %}</h3>
        <p>
          {%- if site.lang == "jp" and member["bio-jp"] -%}
            <strong>{{ member_full_name }}„ÅØ</strong>{{ member["bio-jp"] }}
          {%- else -%}
            <strong>{{ member_full_name }}&nbsp;</strong>{{ member.bio }}
          {%- endif -%}
        </p>
      {%- endif -%}

      {%- if member.rawbio -%}
        {{ member.rawbio }}
      {%- endif -%}

      {%- if member.research -%}
        <h3>{% t member-page.research-interests %}</h3>
        <p>
          {%- if site.lang == "jp" and member["research-jp"] -%}
            {{ member["research-jp"] }}
          {%- else -%}
            {{ member.research }}
          {%- endif -%}
        </p>
      {%- endif -%}
    </div>
  </div>


  {%- if member.videos -%}
    <div class="row mt-4">
      <div class="col-12">
        <h3>{% t member-page.videos %}</h3>
      </div>
      {%- for video in member.videos -%}
        <div class="col-sm-6 col-lg-3 text-center mb-3">
          <a href="{{ video.url }}" data-bs-toggle="lightbox" data-bs-gallery="videos" data-bs-title="{{ video.title }}">
            <img src="{{ video.img }}" class="img-fluid rounded mb-2" alt="{{ video.title }} snapshot">
            {% if site.lang == "jp" and video["title-jp"] %}
              <div>{{ video["title-jp"] }}</div>
            {% else %}
              <div>{{ video.title }}</div>
            {% endif %}
          </a>
        </div>
      {%- endfor -%}
    </div>
  {%- endif -%}

  <div class="row mt-4">
    <div class="col-12">
      {%- if member.selected_publications -%}
        <h3>{% t member-page.selected-publications %}</h3>
        {%- include publications_table.html publications_id=member.selected_publications -%}

        <h3 class="mt-4">{% t member-page.all-publications %} <a id="all_pubs_button" class="btn btn-sm btn-link" data-bs-toggle="collapse" href="#all_pubs">{% t member-page.show %}</a></h3>
        <div id="all_pubs" class="collapse">
          {%- include publications_table.html member_id=member.id -%}
        </div>
      {%- else -%}
        <h3>{% t pages.publications %}</h3>
        <div class="alert alert-info">{% t publications.incomplete-warning %}</div>
        {%- include publications_table.html member_id=member.id -%}
      {%- endif -%}
    </div>
  </div>

</div>
